name: Build
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: x86_64
            platform: linux/amd64
          - arch: armv7
            platform: linux/arm/v7
          - arch: aarch64
            platform: linux/arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Write build script
        run: |
          cat > "$PWD/docker-build.sh" << 'SCRIPT'
          #!/bin/sh
          set -e

          apk add --no-cache build-base automake autoconf libtool \
            openssl-dev openssl-libs-static \
            zlib-dev zlib-static \
            linux-headers git wget \
            jansson-dev jansson-static

          # Build minimal static curl
          cd /tmp
          wget -q https://curl.se/download/curl-8.5.0.tar.gz
          tar xzf curl-8.5.0.tar.gz
          cd curl-8.5.0
          ./configure \
            --disable-shared \
            --enable-static \
            --with-openssl \
            --with-zlib \
            --disable-ldap \
            --disable-ldaps \
            --disable-rtsp \
            --disable-dict \
            --disable-telnet \
            --disable-tftp \
            --disable-pop3 \
            --disable-imap \
            --disable-smb \
            --disable-smtp \
            --disable-gopher \
            --disable-mqtt \
            --disable-manual \
            --disable-libcurl-option \
            --without-brotli \
            --without-zstd \
            --without-libpsl \
            --without-libidn2 \
            --without-nghttp2
          make -j$(nproc)
          make install

          # Build ccminer
          cd /src
          chmod -R u+rwx .
          chmod +x autogen.sh install-sh compile config.guess config.sub missing depcomp 2>/dev/null || true

          # -------------------------------------------------------------------
          # ARMv7 patches
          # -------------------------------------------------------------------
          if [ "$TARGET_ARCH" = "armv7" ]; then

            # BUG FIX 2: data_key alignment - replace malloc with posix_memalign(16)
            if [ -f verus/verusscan.cpp ]; then
              sed -i 's|u128 \*data_key =  (u128\*)malloc(VERUS_KEY_SIZE + 1024);|u128 *data_key = NULL; if (posix_memalign((void **)&data_key, 16, VERUS_KEY_SIZE + 1024) != 0) return 0;|' verus/verusscan.cpp
            fi

            # BUG FIX 3: blockhash_half stack alignment
            if [ -f verus/verusscan.cpp ]; then
              sed -i 's|uint8_t blockhash_half\[64\] = { 0 };|uint8_t __attribute__((aligned(16))) blockhash_half[64] = { 0 };|' verus/verusscan.cpp
            fi

            # BUG FIX 4: buf2 alignment - split combined alignas declaration
            if [ -f verus/verusscan.cpp ]; then
              sed -i 's|alignas(32) unsigned char buf1\[64\] = { 0 }, buf2\[64\];|alignas(32) unsigned char buf1[64] = { 0 };\n\talignas(32) unsigned char buf2[64];|' verus/verusscan.cpp
            fi

          fi

          # -------------------------------------------------------------------
          # AArch64 patches: swap in NEON-optimised sources (has hw AES)
          # -------------------------------------------------------------------
          if [ "$TARGET_ARCH" = "aarch64" ]; then
            if [ -f verus/haraka_neon.c ] && [ -f verus/haraka.c ]; then
              cp verus/haraka.c verus/haraka_x86.c.bak
              cp verus/haraka_neon.c verus/haraka.c
            fi
            if [ -f verus/verus_clhash_neon.cpp ] && [ -f verus/verus_clhash.cpp ]; then
              cp verus/verus_clhash.cpp verus/verus_clhash_x86.cpp.bak
              cp verus/verus_clhash_neon.cpp verus/verus_clhash.cpp
            fi
          fi

          sh autogen.sh

          if [ "$TARGET_ARCH" = "x86_64" ]; then
            FLAGS="-maes -msse3 -mssse3 -mpclmul"
          elif [ "$TARGET_ARCH" = "armv7" ]; then
            FLAGS="-mfpu=neon"
          elif [ "$TARGET_ARCH" = "aarch64" ]; then
            FLAGS="-march=armv8-a+crypto"
          else
            FLAGS=""
          fi

          ./configure \
            CFLAGS="-O3 $FLAGS" \
            CXXFLAGS="-O3 $FLAGS" \
            LDFLAGS="-static" \
            --with-curl \
            --disable-dependency-tracking

          make -j$(nproc) || exit 1

          if [ ! -f ccminer ]; then
            echo "Build failed - binary not found"
            exit 1
          fi

          strip ccminer 2>/dev/null || true
          mv ccminer ccminer-"$TARGET_ARCH"
          file ccminer-"$TARGET_ARCH"
          ldd ccminer-"$TARGET_ARCH" 2>&1 | grep -q "not a dynamic" && echo "Static OK" || echo "Warning: not static"
          SCRIPT
          chmod +x "$PWD/docker-build.sh"

      - name: Build ${{ matrix.arch }}
        run: |
          docker run --rm \
            --platform ${{ matrix.platform }} \
            -v "$PWD":/src \
            -w /src \
            -e TARGET_ARCH=${{ matrix.arch }} \
            alpine:3.19 \
            sh /src/docker-build.sh

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ccminer-${{ matrix.arch }}
          path: ccminer-${{ matrix.arch }}
          if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release
        run: |
          mkdir -p release
          find artifacts -name "ccminer-*" -exec cp {} release/ \;
          cd release
          chmod +x ccminer-*
          sha256sum ccminer-* > SHA256SUMS
          ls -lh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body: |
            Checksums: SHA256SUMS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
